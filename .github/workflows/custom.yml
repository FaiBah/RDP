name: Windows RDP with Playit (auto URL)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Enable RDP and set password
        run: |
          net user runneradmin MyStrongPassword123!
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Download Playit Agent
        run: |
          Invoke-WebRequest -Uri https://github.com/playit-cloud/playit-agent/releases/download/v0.16.3/playit-windows-x86_64.exe -OutFile playit.exe

      - name: Login and start RDP tunnel
        id: playit
        run: |
          # Login using auth key from secret
          echo $env:PLAYIT_AUTH_KEY | ./playit.exe login

          # Start RDP tunnel in background
          Start-Process -FilePath ./playit.exe -ArgumentList "rdp start" -NoNewWindow

          # Wait a few seconds for the tunnel to initialize
          Start-Sleep -Seconds 5

          # Get RDP public URL
          $output = ./playit.exe rdp status
          Write-Output "RDP_URL=$output" >> $env:GITHUB_ENV
        env:
          PLAYIT_AUTH_KEY: ${{ secrets.PLAYIT_AUTH_KEY }}

      - name: Show login info
        run: |
          Write-Host "============================================================"
          Write-Host "✅ RDP is ready!"
          Write-Host "👤 Username: runneradmin"
          Write-Host "🔑 Password: MyStrongPassword123!"
          Write-Host "🌍 Playit RDP URL: $env:RDP_URL"
          Write-Host "============================================================"
