name: Windows RDP with Playit (auto URL)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Enable RDP and set password
        run: |
          net user runneradmin MyStrongPassword123!
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Download Playit CLI
        run: |
          Invoke-WebRequest -Uri https://github.com/playit-cloud/playit-agent/releases/download/v0.16.3/playit-windows-x86_64.exe -OutFile playit.exe

      - name: Start Playit tunnel and capture URL
        id: playit
        run: |
          $output = Start-Process -FilePath playit.exe -ArgumentList "authtoken $env:PLAYIT_AUTH_KEY" -NoNewWindow -PassThru -Wait -RedirectStandardOutput temp.txt
          $url = Select-String -Path temp.txt -Pattern "RDP" | ForEach-Object { $_.Line }
          Write-Output "RDP_URL=$url" >> $env:GITHUB_ENV
        env:
          PLAYIT_AUTH_KEY: ${{ secrets.PLAYIT_AUTH_KEY }}

      - name: Show login info
        run: |
          Write-Host "============================================================"
          Write-Host "âœ… RDP is ready!"
          Write-Host "ğŸ‘¤ Username: runneradmin"
          Write-Host "ğŸ”‘ Password: MyStrongPassword123!"
          Write-Host "ğŸŒ Playit RDP URL: $env:RDP_URL"
          Write-Host "============================================================"
